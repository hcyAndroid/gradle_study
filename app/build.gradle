//apply plugin: 'com.android.application'
//
//apply plugin: 'kotlin-android'
//
//apply plugin: 'kotlin-android-extensions'
//DSL åº”ç”¨æ’ä»¶
plugins {
    id 'com.android.application'
    id 'kotlin-android'
    id 'kotlin-android-extensions'
}
apply from: "../config.gradle"


android {
    compileSdkVersion "android-29"
    dataBinding{
        enabled=true
    }
    //é…ç½®ç­¾åä¿¡æ¯
    signingConfigs {

        htjy_test_release {
            storeFile file("../htjy")  //ç­¾åè¯ä¹¦æ–‡ä»¶
            storePassword 'education123' //ç­¾åè¯ä¹¦æ–‡ä»¶çš„å¯†ç 
            keyAlias 'å®é€”æ•™è‚²' //å¯†é’¥åˆ«å
            keyPassword 'education123'//å¯†é’¥çš„å¯†ç 
        }
    }
    defaultConfig {
        applicationId tag1//æŒ‡å®šappçš„åŒ…å
        minSdkVersion 23 //æŒ‡å®šappæœ€ä½æ”¯æŒçš„androidç‰ˆæœ¬
        targetSdkVersion 29
        versionCode getAppVersionCodeFromGit()       //å†…éƒ¨ç‰ˆæœ¬å·
        versionName getAppVersionNameFromGit()//appçš„ç‰ˆæœ¬åç§°-ä¸€èˆ¬æŒ‡ä¸»ç‰ˆæœ¬å·+å‰¯ç‰ˆæœ¬å·+è¡¥ä¸å·android["versionName"]
        testApplicationId "com.hcy.myproject.test" //é…ç½®æµ‹è¯•appçš„åŒ…å
        //Instrumentæµ‹è¯•
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        //  //ç‰ˆæœ¬ååé¢æ·»åŠ ä¸€å¥è¯ï¼Œæ„æ€å°±æ˜¯flavor dimension å®ƒçš„ç»´åº¦å°±æ˜¯è¯¥ç‰ˆæœ¬å·ï¼Œè¿™æ ·ç»´åº¦å°±æ˜¯éƒ½æ˜¯ç»Ÿä¸€çš„äº†
        flavorDimensions "versionCode"
    }
    //é…ç½®adbæ“ä½œé€‰é¡¹
    adbOptions {
        //è®¾ç½®adbè¿æ¥çš„è¶…æ—¶æ—¶é—´
        timeOutInMs = 5 * 1000  //5ç§’
        installOptions '-r', '-s'
    }
    //lint
    lintOptions {
        //ç”¨äºlintå‘ç°é”™è¯¯æ—¶æ˜¯å¦é€€å‡ºgradle æ„å»º
        abortOnError true
        //ç”¨äºé…ç½®é”™è¯¯çš„è¾“å‡ºæ˜¯å¦åº”è¯¥æ˜¾ç¤ºç»å¯¹è·¯å¾„
        absolutePaths true
        //æ£€æŸ¥æ‰€æœ‰è­¦å‘ŠåŒ…æ‹¬å“ªäº›é»˜è®¤è¢«å…³é—­çš„é—®é¢˜
        checkAllWarnings true
        //warningAsErrors true
        check 'NewApi'
        //
        htmlOutput new File("${buildDir}/lintResports/lint-result.html")
        //å¿½ç•¥è­¦å‘Š
        ignoreWarnings true
    }
    //é…ç½®dexé€‰é¡¹
    dexOptions {
        //æ˜¯å¦å¯ç”¨dexå¢é‡æ¨¡å¼ï¼Œé»˜è®¤ä¸å¯ç”¨ï¼Œè™½ç„¶é€Ÿåº¦å¿«ä½†æœ‰é™åˆ¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸å·¥ä½œ,æ…å¯
        incremental false
        //æ‰§è¡Œdxå‘½ä»¤åˆ†é…çš„æœ€å¤§å†…å­˜ï¼Œä¸»è¦è§£å†³GC overheadé—®é¢˜,é»˜è®¤åªæœ‰1g
        javaMaxHeapSize '4g'
        //å‡½æ•°>65535 éœ€å¼ºåˆ¶å¯åŠ¨jumboæ¨¡å¼ï¼Œæ‰èƒ½æ„å»ºæˆåŠŸ
        jumboMode true
        //è¿è¡Œdxå‘½ä»¤æ—¶ä½¿ç”¨çš„çº¿ç¨‹æ•°é‡
        threadCount 3
        //é…ç½®æ˜¯å¦æ‰§è¡Œdex Libraries åº“å·¥ç¨‹ï¼Œå¼€å¯ä¼šæé«˜æ„å»ºé€Ÿåº¦ï¼Œä½†å½±å“cleanï¼Œé»˜è®¤true
        preDexLibraries true
    }
    //é…ç½®javaç¼–è¯‘é€‰é¡¹
    compileOptions {
        //é…ç½®æºæ–‡ä»¶ç¼–ç 
        encoding = "utf-8"
        //é…ç½®javaæºä»£ç çš„ç¼–è¯‘çº§åˆ«
        sourceCompatibility = JavaVersion.VERSION_1_8
        //é…ç½®æˆåŠŸjavaå­—èŠ‚ç çš„ç‰ˆæœ¬
        targetCompatibility = JavaVersion.VERSION_1_8
    }

    //é…ç½®æ„å»ºçš„ç±»å‹
    buildTypes {
        release {
            debuggable false   //ä¸å¯è°ƒè¯•ï¼Œè¡¨è±¡logæ‰“ä¸å‡ºæ¥
            jniDebuggable false //ä¸å¯è°ƒè¯•jni
            minifyEnabled true //å¯ç”¨æ··æ·†
            shrinkResources true //è‡ªåŠ¨æ¸…ç†æœªä½¿ç”¨çš„èµ„æº
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            multiDexEnabled true //å¯ç”¨è‡ªåŠ¨æ‹†åˆ†å¤šä¸ªDexçš„åŠŸèƒ½ï¼Œä¸»è¦ç”¨äºå¤„ç†>65535çš„æ–¹æ³•
            applicationIdSuffix '.release' //åŒ…ååç¼€
            zipAlignEnabled true //æ‰“å¼€ä¸€ä¸ªzipalignå·¥å…·ï¼Œæ•´ç†å’Œä¼˜åŒ–apkæ–‡ä»¶çš„å·¥å…·ï¼Œæé«˜ç³»ç»Ÿå’Œåº”ç”¨çš„è¿è¡Œæ•ˆç‡ï¼Œæ›´å¿«çš„è¯»å†™apkä¸­çš„èµ„æºï¼Œé™ä½å†…å­˜çš„ä½¿ç”¨
            signingConfig signingConfigs.htjy_test_release  //é…ç½®é»˜è®¤çš„ç­¾åä¿¡æ¯
        }
        debug {
            debuggable true  //å¯è°ƒè¯•ï¼Œlogå¯è§
            minifyEnabled true //ä¸å¯ç”¨æ··æ·†
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            shrinkResources true //è‡ªåŠ¨æ¸…ç†æœªä½¿ç”¨çš„èµ„æºï¼Œè¿™æ˜¯ä½¿ç”¨å¿…é¡»è¦æ‰“å¼€æ··æ·†
            jniDebuggable true //å¯è°ƒè¯•jni
            multiDexEnabled true //å¯ç”¨è‡ªåŠ¨æ‹†åˆ†å¤šä¸ªDexçš„åŠŸèƒ½ï¼Œä¸»è¦ç”¨äºå¤„ç†>65535çš„æ–¹æ³•
            zipAlignEnabled true //æ‰“å¼€ä¸€ä¸ªzipalignå·¥å…·ï¼Œæ•´ç†å’Œä¼˜åŒ–apkæ–‡ä»¶çš„å·¥å…·ï¼Œæé«˜ç³»ç»Ÿå’Œåº”ç”¨çš„è¿è¡Œæ•ˆç‡ï¼Œæ›´å¿«çš„è¯»å†™apkä¸­çš„èµ„æºï¼Œé™ä½å†…å­˜çš„ä½¿ç”¨
            applicationIdSuffix '.debug' //åŒ…ååç¼€
        }
    }
    //æ‰¹é‡ä¿®æ”¹ç”Ÿæˆçš„apkçš„æ–‡ä»¶å
    applicationVariants.all { variant ->
        println("æ‰“å°1111>>>${variant.buildType.name}")
        variant.outputs.all {
            outputFileName = "${variant.versionCode}_hcy2019_${variant.flavorName}_${variant.versionName}_${buildTime()}.apk"
//            if (output.outputFile != null&&output.outputFile.name.endsWith('.apk')) {
//                //def apk=new File(output.outputFile.getParent(),"hcy2019.apk")
//                //output.outputFile=apk
//
//                println("æ‰“å°2222>>>${output.outputFile.name}")
//            }
        }
    }
    //å£°æ˜é…ç½®æ¸ é“çš„ç»´åº¦
    flavorDimensions 'company', 'version'

    //é…ç½®æ¸ é“
    productFlavors {
        htjy {
            //å¯ä»¥ç»™æ¯ä¸ªæ¸ é“éƒ½è®¾ç½®ä¸åŒçš„åŒ…å
            applicationId "com.hcy.myproject.htjy"
            buildConfigField "String", "TEST_URL", '"http://www.baidu.com"'
            buildConfigField "Boolean", "tag01", 'true'
            resValue "string", "product_name", "å®é€”æ•™è‚²"
            //å¯¹androidåº“é¡¹ç›®æ··æ·†
            consumerProguardFiles 'proguard-rules.pro', 'proguard-android.txt'
            //è®¾ç½®æµ‹è¯•åŒ…å
            testApplicationId 'com.hcy.myproject.htjy.test'
            //æ˜¯å¦ä¸ºåŠŸèƒ½æµ‹è¯•
            testFunctionalTest true
            //æ˜¯å¦å¯ç”¨åˆ†æåŠŸèƒ½
            testHandleProfiling true
            //è®¾ç½®ç»´åº¦
            dimension 'company'

        }
        ygsj {
            applicationId "com.hcy.myproject.ygsj"
            testApplicationId 'com.hcy.myproject.ygsj.test'
            dimension 'company'
        }
        wyt {
            applicationId "com.hcy.myproject.wyt"
            testApplicationId 'com.hcy.myproject.wyt.test'
            dimension 'company'
        }
        ali {
            dimension 'version'
        }
    }
}
//ä»gitä¸­æ ¹æ®tagçš„æ•°é‡è·Ÿæ–°ç‰ˆæœ¬å·
def getAppVersionCodeFromGit() {
    def stdout = new ByteArrayOutputStream()
    exec {
        commandLine 'git', 'tag', '--list'
        standardOutput = stdout
    }
    return stdout.toString().split("\n").size()
}
//ä»gitä¸­è·å–åº”ç”¨çš„ç‰ˆæœ¬åç§°
def getAppVersionNameFromGit() {
    def stdout = new ByteArrayOutputStream()
    exec {
        commandLine 'git', 'describe', "--abbrev=0", "--tags"
        standardOutput = stdout
    }
    return stdout.toString().trim()
}

def buildTime() {
    def date = new Date()
    return date.format("yyyy_MM_dd_HH_mm_ss")
}

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation commonDependencies['kt']
    implementation commonDependencies['appcompatx']
    implementation commonDependencies['ktx']
    implementation project(path: ':utilslib')
    api libDependencies['constraintlayout']
    implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:$kotlin_coroutines"
    //                                       ğŸ‘‡ ä¾èµ–å½“å‰å¹³å°æ‰€å¯¹åº”çš„å¹³å°åº“
    implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:$kotlin_coroutines"
    implementation 'androidx.lifecycle:lifecycle-extensions:2.1.0'

}
